<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BLE Checksum Brute-Forcer (Payload Extractor)</title>
    <style>
        body { font-family: sans-serif; background-color: #2c2c2c; color: #f0f0f0; padding: 20px; }
        button { padding: 10px 15px; font-size: 16px; margin: 5px 0; border-radius: 5px; border: 1px solid #666; background-color: #444; color: white; cursor: pointer; width: 100%; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #555; }
        #log { width: 100%; height: 400px; background-color: #1e1e1e; border: 1px solid #555; border-radius: 5px; overflow-y: scroll; font-family: monospace; font-size: 12px; white-space: pre-wrap; padding: 10px; box-sizing: border-box; }
        .log-sent { color: #87cefa; }
        .log-received { color: #98fb98; }
        .log-error { color: #ff6b6b; }
        .log-info { color: #f0e68c; }
        .log-success { color: #32cd32; font-weight: bold; }
        .config-section { background-color: #3a3a3a; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        h2 { margin-top: 0; }
        .config-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .config-row label { min-width: 180px; }
        .config-row input { background-color: #222; border: 1px solid #555; color: white; padding: 5px; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>BLE Checksum Brute-Forcer (Payload Extractor)</h1>
    <p>Enter a full command or just a payload. The tool will automatically extract the payload and find the correct checksum.</p>

    <div class="config-section">
        <h2>Command to Test</h2>
        <div class="config-row">
            <label for="payload">Command or Payload (Hex):</label>
            <input type="text" id="payload" value="8080f0000000010000000601010403050e000000000000f7" style="width: 400px;">
        </div>
    </div>

    <button id="connectBtn">1. Connect</button>
    <button id="startBruteForceBtn" disabled>2. Start Brute-Force</button>
    
    <div id="log"></div>

    <script>
        // --- CONFIGURATION ---
        const SERVICE_UUID = '03b80e5a-ede8-4b33-a751-6ce34ec4c700';
        const CHARACTERISTIC_UUID = '7772e5db-3868-4112-a1a9-f2669d106bf3';
        const SUCCESS_ACK_CODE = "8080f00b02000100000003010400080000f7";

        // --- SCRIPT STATE ---
        let device = null;
        let characteristic = null;
        let ackPromiseResolver = null;

        // --- UI ELEMENTS ---
        const connectBtn = document.getElementById('connectBtn');
        const startBruteForceBtn = document.getElementById('startBruteForceBtn');
        const logElement = document.getElementById('log');

        // --- BLE LOGIC ---

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = `log-${type}`;
            logElement.innerHTML += `<span class="${typeClass}">[${timestamp}] ${message}\n</span>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        connectBtn.addEventListener('click', async () => {
            try {
                log('Requesting Bluetooth device...', 'sent');
                device = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
                log(`Connecting to ${device.name || 'Unknown Device'}...`, 'sent');
                device.addEventListener('gattserverdisconnected', () => {
                    log('Device disconnected.', 'error');
                    connectBtn.disabled = false;
                    startBruteForceBtn.disabled = true;
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleNotification);
                log('Device connected successfully!', 'success');
                connectBtn.disabled = true;
                startBruteForceBtn.disabled = false;
            } catch (error) {
                log(`Connection failed: ${error.message}`, 'error');
            }
        });

        async function writeCommand(commandString) {
            if (!characteristic) return;
            try {
                const hexBytes = commandString.match(/.{1,2}/g).map(byte => parseInt(byte, 16));
                const command = new Uint8Array(hexBytes);
                log(`Sending: ${commandString}`, 'sent');
                await characteristic.writeValueWithoutResponse(command);
            } catch (error) {
                log(`Error sending command: ${error.message}`, 'error');
            }
        }

        function handleNotification(event) {
            const data = new Uint8Array(event.target.value.buffer);
            const hexString = Array.from(data).map(b => b.toString(16).padStart(2, '0')).join('');
            
            if (ackPromiseResolver) {
                // Check if the received message is the success ACK
                if (hexString.toLowerCase() === SUCCESS_ACK_CODE) {
                    log(`SUCCESS ACK Received: ${hexString.toUpperCase()}`, 'received');
                    ackPromiseResolver(true);
                } else {
                    log(`Received (non-ACK): ${hexString.toUpperCase()}`, 'received');
                }
            } else {
                log(`Received (unhandled): ${hexString.toUpperCase()}`, 'received');
            }
        }
        
        function waitForAck() {
            return new Promise((resolve, reject) => {
                ackPromiseResolver = resolve;
                // Wait 200ms for an ACK. If none is received, assume failure.
                const timeout = setTimeout(() => {
                    ackPromiseResolver = null;
                    resolve(false); // Resolve with 'false' on timeout
                }, 200);
            });
        }

        // --- BRUTE-FORCE LOGIC ---

        startBruteForceBtn.addEventListener('click', async () => {
            startBruteForceBtn.disabled = true;
            log('--- Starting Checksum Brute-Force (ACK Verification) ---', 'info');

            // === MODIFICATION START ===
            const userInput = document.getElementById('payload').value.trim().replace(/\s/g, '');
            let payload;

            // Check if the input looks like a full command and extract the payload
            if (userInput.toLowerCase().startsWith('8080f0') && userInput.toLowerCase().endsWith('f7')) {
                // The payload is the string between the header+checksum (10 chars) and the footer (2 chars)
                payload = userInput.slice(10, -2);
                log(`Full command detected. Extracted payload: ${payload}`, 'info');
            } else {
                // Otherwise, assume the entire input is the payload
                payload = userInput;
                log(`Assuming input is a payload only.`, 'info');
            }
            // === MODIFICATION END ===

            for (let x = 0; x < 16; x++) {
                for (let y = 0; y < 16; y++) {
                    const checksumX = x.toString(16);
                    const checksumY = y.toString(16);
                    const checksum = `0${checksumX}0${checksumY}`;
                    
                    const testCommand = `8080f0${checksum}${payload}f7`;
                    
                    log(`\nTesting checksum ${checksum.toUpperCase()}...`, 'info');
                    
                    await writeCommand(testCommand);
                    const wasSuccessful = await waitForAck();

                    if (wasSuccessful) {
                        log(`\n==================================================`, 'success');
                        log(`SUCCESS! Device sent the correct ACK message.`, 'success');
                        log(`The correct checksum is: ${checksum.toUpperCase()}`, 'success');
                        log(`Full working command: ${testCommand}`, 'success');
                        log(`==================================================`, 'success');
                        startBruteForceBtn.disabled = false;
                        return;
                    } else {
                        log('-> No success ACK received.', 'info');
                    }
                }
            }

            log('\n--- Brute-Force Complete ---', 'info');
            log('No checksum triggered the success ACK from the device.', 'error');
            startBruteForceBtn.disabled = false;
        });

    </script>
</body>
</html>
